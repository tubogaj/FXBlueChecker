<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FXBlue Multi-Account Dashboard</title>
<style>
body{font-family:"Segoe UI",Arial,sans-serif;background:#0f172a;color:#f8fafc;margin:0;padding:20px;}
h1{text-align:center;color:#38bdf8}
.container{max-width:1200px;margin:0 auto;}
textarea{width:100%;height:120px;padding:10px;border-radius:8px;border:none;font-family:monospace;}
button{background:#38bdf8;color:#0f172a;font-weight:bold;padding:10px 20px;border:none;border-radius:6px;cursor:pointer;margin-top:10px;}
button:hover{background:#0ea5e9;}
#timestamp{text-align:center;color:#94a3b8;margin-top:10px;}
#results{margin-top:30px;display:grid;gap:25px;grid-template-columns:repeat(auto-fit,minmax(500px,1fr));}
.card{background:#1e293b;border-radius:10px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,0.3);}
.card h2{color:#38bdf8;margin-top:0;}
.summary{background:#0f172a;border-radius:6px;padding:10px;margin-bottom:10px;}
.summary div{margin:5px 0;font-size:0.95rem;}
iframe{border:none;width:100%;height:280px;border-radius:6px;}
a{color:#38bdf8;text-decoration:none;}
a:hover{text-decoration:underline;}
.green{color:#22c55e;font-weight:bold;}
.red{color:#ef4444;font-weight:bold;}
.loading{color:#facc15;}
</style>
</head>
<body>
<div class="container">
  <h1>üíπ FXBlue Multi-Account Dashboard</h1>
  <p>Enter one or more FXBlue links (one per line):</p>
  <textarea id="links" placeholder="https://www.fxblue.com/users/example1
https://www.fxblue.com/users/example2"></textarea>
  <button onclick="buildDashboard()">Show Accounts</button>
  <div id="timestamp"></div>
  <div id="results"></div>
</div>

<script>
async function buildDashboard(){
  const container=document.getElementById("results");
  container.innerHTML="";
  document.getElementById("timestamp").innerText="Dashboard refreshed: "+new Date().toLocaleString();

  const links=document.getElementById("links").value.trim().split("\n");

  for(const link of links){
    if(!link)continue;
    const username=link.trim().split("/").pop();
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<h2>${username}</h2><p class="loading">‚è≥ Loading data‚Ä¶</p>`;
    container.appendChild(card);

    try{
      // --- XML feed (Balance + Equity)
      const xmlRes=await fetch(`https://fxbluechecker.tubogaj.workers.dev/?user=${username}/xml`);
      const xmlText=await xmlRes.text();
      const xml=new DOMParser().parseFromString(xmlText,"text/xml");
      const getVal=tag=>xml.getElementsByTagName(tag)[0]?.textContent||"N/A";
      const balance=getVal("balance");
      const equity=getVal("equity");

      // --- Full HTML
      const htmlRes=await fetch(`https://fxbluechecker.tubogaj.workers.dev/?user=${username}`);
      const html=await htmlRes.text();
      const clean=html.replace(/\s+/g," ");

      // --- Floating & Closed Profit
      function extract(label){
        const re=new RegExp(label+"[^\\d-]*([+-]?[\\d,\\.]+)","i");
        const m=clean.match(re);
        return m?m[1]:"N/A";
      }
      const floating=extract("Floating P/?L");
      const closed=extract("Closed profit");

      // --- Last Update from Overview
      let fxUpdated="N/A";
      const updateMatch=html.match(/Last\s*update<\/td>\s*<td[^>]*>(?:<[^>]+>)*([^<]+)(?:<\/[^>]+>)*<\/td>/i);
      if(updateMatch){
        fxUpdated=updateMatch[1].trim();
        // if only time (e.g. 15:32:16), add today's date
        if(/^\d{1,2}:\d{2}(:\d{2})?$/.test(fxUpdated)){
          const today=new Date().toISOString().split("T")[0];
          fxUpdated=`${today} ${fxUpdated}`;
        }
      }

      // --- Color coding
      const fNum=parseFloat(floating.replace(/[^0-9.-]/g,""));
      const cNum=parseFloat(closed.replace(/[^0-9.-]/g,""));
      const fColor=isNaN(fNum)?"":(fNum>=0?"green":"red");
      const cColor=isNaN(cNum)?"":(cNum>=0?"green":"red");

      // --- Output
      card.innerHTML=`
        <h2><a href="https://www.fxblue.com/users/${username}" target="_blank">${username}</a></h2>
        <div class="summary">
          <div>üí∞ <b>Balance:</b> ${balance}</div>
          <div>üìà <b>Equity:</b> ${equity}</div>
          <div>üíπ <b>Floating P/L:</b> <span class="${fColor}">${floating}</span></div>
          <div>üìò <b>Closed Profit:</b> <span class="${cColor}">${closed}</span></div>
          <div>üïí <b>Last Update:</b> ${fxUpdated}</div>
        </div>
        <iframe src="https://www.fxblue.com/users/${username}/chart?type=equity"></iframe>
        <p><a href="https://www.fxblue.com/users/${username}" target="_blank">üîó View full FXBlue page</a></p>`;
    }catch(err){
      card.innerHTML=`<h2>${username}</h2><p class="red">‚ùå Error loading data: ${err.message}</p>`;
    }
  }
}
</script>
</body>
</html>
